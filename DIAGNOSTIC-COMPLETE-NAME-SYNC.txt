#!/usr/bin/env python3
"""
Script pour montrer comment diagnostiquer le problÃ¨me de synchronisation du nom
"""

print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                     GUIDE DIAGNOSTIC COMPLET                              â•‘
â•‘              Synchronisation du NOM depuis l'app vers Google Sheets        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ SITUATION ACTUELLE:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… Database: 1 PRODUCT_PATCH pending pour produit "1" 
   - Name: "crist"
   - Unit level: "CARTON"
   - Status: "pending" (pas encore envoyÃ©)

âŒ Google Sheets: Produit "1" a le NOM VIDE
   - Code: 1
   - Name: [VIDE] <- ProblÃ¨me ici
   - Stock: 44396
   - UUID: 1d6f6b3b-f378-471c-94e4-41ee1d069095

âš ï¸  CAUSE RACINE:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
isOnline = false (connexion dÃ©tectÃ©e comme perdue)
â†“
pushPendingOperations() refuse de pousser quand isOnline=false
â†“
PRODUCT_PATCH reste en "pending" au lieu d'Ãªtre envoyÃ© Ã  Sheets

ğŸ”§ SOLUTION IMMÃ‰DIATE:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

OPTION 1: RedÃ©marrer l'app (rÃ©initialise isOnline = true)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  1. Ctrl+C pour arrÃªter npm run dev
  2. npm run dev
  3. Attendre 10-15 secondes
  4. PRODUCT_PATCH devrait Ãªtre envoyÃ© automatiquement
  5. VÃ©rifier Google Sheets aprÃ¨s ~30 secondes

OPTION 2: Forcer l'envoi via API (si le serveur tourne)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  curl -X POST http://localhost:3000/api/sync/reset-online-and-push

OPTION 3: VÃ©rifier les logs en dÃ©tail
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Chercher dans le terminal "npm run dev":
  
  ğŸ” Logs clÃ©s Ã  chercher:
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  1ï¸âƒ£ PRODUCT_PATCH crÃ©Ã©:
     ğŸ’¡ Log Ã  voir: "ğŸ“¤ [PATCH-ENQUEUE-UNIT] Produit 1/CARTON"
     
  2ï¸âƒ£ Tentative de push:
     ğŸ’¡ Log Ã  voir: "ğŸ“¤ [pushProductPatches]" ou "ğŸ“¤ [PUSH-SYNC]"
     
  3ï¸âƒ£ ProblÃ¨me de connexion:
     ğŸ’¡ Log Ã  voir: "âš ï¸ [INTERNET] Connexion Internet perdue"
     ğŸ’¡ Si vous voyez ce log = le push est bloquÃ©
     
  4ï¸âƒ£ RÃ©ception par Google Apps Script:
     ğŸ’¡ Log Ã  voir: "ğŸ“¤ [PUSH-SYNC] Pushing X opÃ©ration(s) to Sheets"
     ğŸ’¡ Log Ã  voir: "[handleProductUpsert] name='crist'"
     
  5ï¸âƒ£ SuccÃ¨s dans Sheets:
     ğŸ’¡ Log Ã  voir: "âœ… Upsert terminÃ©: ligne X, feuille CARTON"

ğŸ¯ FLUX COMPLET (si tout fonctionne):
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  USER MODIFIE LE NOM
         â†“
  products.routes.js PUT /api/products/1
         â†“
  [ğŸ“¤ [PATCH-ENQUEUE-UNIT] Produit 1/CARTON: name='nouveau-nom']
         â†“
  outbox.repo.js crÃ©e PRODUCT_PATCH
         â†“
  sync_operations table: status='pending'
         â†“
  sync.worker startPushSyncLoop() (toutes les 15 secondes)
         â†“
  SI isOnline=true: pushProductPatches()
         â†“
  [ğŸ“¤ [pushProductPatches] sheetsUrl='...]
  [PRODUCT-PATCH 0] Parsing payload...
         â†“
  sheetsClient.post() vers Google Sheets
         â†“
  Code.gs doPost() reÃ§oit les donnÃ©es
  [ğŸ“¤ [doPost] action='batchPush', received X operation(s)]
         â†“
  Code.gs handleProductUpsert()
  [ğŸ“¦ [handleProductUpsert] Extraction champs: name='nouveau-nom']
         â†“
  Ã‰crit dans Sheets ligne du produit 1, colonne "Nom du produit"
  [âœ… Nom Ã‰CRIT: 'nouveau-nom']
         â†“
  Google Sheets: Produit 1 a maintenant le nom "nouveau-nom" âœ…

âš¡ COMMANDES DE TEST:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Pour tester manuellement si la synchronisation fonctionne:

1. DÃ©marrer l'app: npm run dev

2. Dans une autre console, attendre 10 secondes puis:
   python test-product-sync-trace.py
   
   OU avec curl:
   curl -X POST http://localhost:3000/api/sync/reset-online-and-push

3. Regarder les logs du "npm run dev" pour voir le flux complet

4. VÃ©rifier Google Sheets aprÃ¨s 30 secondes

ğŸ“Š Ã‰TAT ATTENDU:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… Si le nom "crist" (ou "TEST-SYNC-xxxxx") apparaÃ®t dans Google Sheets:
   â†’ Synchronisation fonctionne!
   â†’ Les modifications futures seront aussi synchronisÃ©es

âŒ Si le nom reste vide aprÃ¨s 1 minute:
   â†’ Chercher dans les logs: "[INTERNET] Connexion Internet perdue"
   â†’ OU chercher: erreur d'authentification Google Sheets
   â†’ OU chercher: "handleProductUpsert] Erreur" 

ğŸ› ï¸ DÃ‰BOGAGE AVANCÃ‰:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Si la synchronisation ne fonctionne toujours pas:

1. VÃ©rifier que Google Apps Script URL est correcte:
   echo $GOOGLE_SHEETS_WEBAPP_URL
   
2. VÃ©rifier la base de donnÃ©es:
   python check-pending-patch.py
   
3. VÃ©rifier l'Ã©tat de la connexion:
   Logs: chercher "isOnline =" ou "[INTERNET]"
   
4. VÃ©rifier les logs de Google Apps Script:
   https://script.google.com/home/projects/[PROJECT_ID]/executions
   Chercher les erreurs dans "doPost" ou "handleProductUpsert"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
""")
